---
phase: 02-file-upload-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php]
autonomous: false
---

<objective>
Add file validation, upload progress, and user controls to complete the upload experience.

Purpose: Ensure only valid zip files within size limits are accepted, with clear feedback during upload.
Output: Complete upload interface with validation, progress bar, cancel, and remove/replace functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-upload-core/02-01-SUMMARY.md
@app/Filament/Pages/Upload.php
@resources/views/filament/pages/upload.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add zip-only and file size validation with error messages</name>
  <files>app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php</files>
  <action>
    Implement file validation using Livewire's validation:

    1. In Upload.php, add validation rules:
       ```php
       protected $rules = [
           'archive' => [
               'required',
               'file',
               'mimes:zip',
               'max:102400', // 100MB limit
           ],
       ];

       protected $messages = [
           'archive.mimes' => 'Only ZIP files are accepted. Please upload a .zip archive.',
           'archive.max' => 'File size exceeds the 100MB limit. Please upload a smaller archive.',
           'archive.required' => 'Please select a file to upload.',
       ];
       ```

    2. Add `updatedArchive()` method for real-time validation:
       ```php
       public function updatedArchive()
       {
           $this->validateOnly('archive');
       }
       ```

    3. In Blade view, display validation errors clearly:
       ```blade
       @error('archive')
           <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
               <div class="flex items-center">
                   <x-heroicon-o-exclamation-circle class="w-5 h-5 text-red-500 mr-2" />
                   <span class="text-sm text-red-700">{{ $message }}</span>
               </div>
           </div>
       @enderror
       ```

    4. Display file size limit prominently on the upload zone:
       ```blade
       <p class="mt-2 text-xs text-gray-400">
           Accepted: .zip files up to 100MB
       </p>
       ```

    5. On HTML input, ensure accept attribute is set:
       `accept=".zip,application/zip,application/x-zip-compressed"`

    Requirements covered:
    - UPLD-04: Reject non-zip files with clear message
    - UPLD-05: Reject oversized files with clear limit shown
  </action>
  <verify>
    1. Upload a .txt file - error message shows "Only ZIP files are accepted"
    2. Upload zone shows "up to 100MB" limit text
    3. Validation happens immediately after file selection (not on submit)
  </verify>
  <done>
    - Non-zip files rejected with clear error message
    - File size limit displayed and enforced
    - Validation errors appear inline below upload zone
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progress bar, cancel upload, and remove/replace functionality</name>
  <files>app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php</files>
  <action>
    Implement upload progress and controls using Livewire features:

    1. **Progress bar** - Livewire's WithFileUploads provides progress events:
       ```blade
       <div x-data="{ progress: 0, uploading: false }"
            x-on:livewire-upload-start="uploading = true"
            x-on:livewire-upload-finish="uploading = false; progress = 0"
            x-on:livewire-upload-error="uploading = false"
            x-on:livewire-upload-progress="progress = $event.detail.progress">

           <!-- Progress bar shown during upload -->
           <div x-show="uploading" class="mt-4">
               <div class="flex items-center justify-between mb-1">
                   <span class="text-sm text-gray-600">Uploading...</span>
                   <span class="text-sm text-gray-600" x-text="progress + '%'"></span>
               </div>
               <div class="w-full bg-gray-200 rounded-full h-2">
                   <div class="bg-primary-600 h-2 rounded-full transition-all duration-300"
                        :style="'width: ' + progress + '%'"></div>
               </div>
           </div>
       </div>
       ```

    2. **Cancel upload** - Add cancel button during upload:
       ```blade
       <button x-show="uploading"
               x-on:click="$wire.cancelUpload('archive')"
               class="mt-2 text-sm text-red-600 hover:text-red-800">
           Cancel upload
       </button>
       ```

       In Upload.php, add cancel method:
       ```php
       public function cancelUpload($property)
       {
           $this->$property = null;
           $this->resetValidation($property);
       }
       ```

    3. **Remove/Replace file** - Add controls after file is selected:
       ```blade
       @if($archive && !$errors->has('archive'))
           <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
               <div class="flex items-center justify-between">
                   <div class="flex items-center">
                       <x-heroicon-o-document class="w-8 h-8 text-gray-400 mr-3" />
                       <div>
                           <p class="text-sm font-medium text-gray-900">
                               {{ $archive->getClientOriginalName() }}
                           </p>
                           <p class="text-xs text-gray-500">
                               {{ number_format($archive->getSize() / 1024 / 1024, 2) }} MB
                           </p>
                       </div>
                   </div>
                   <div class="flex items-center space-x-2">
                       <!-- Replace button -->
                       <label class="text-sm text-primary-600 hover:text-primary-800 cursor-pointer">
                           Replace
                           <input type="file" wire:model="archive" accept=".zip" class="hidden" />
                       </label>
                       <!-- Remove button -->
                       <button wire:click="removeFile"
                               class="text-sm text-red-600 hover:text-red-800">
                           Remove
                       </button>
                   </div>
               </div>
           </div>
       @endif
       ```

       In Upload.php:
       ```php
       public function removeFile()
       {
           $this->archive = null;
           $this->resetValidation('archive');
       }
       ```

    4. Add "Submit" button (disabled until valid file selected):
       ```blade
       <div class="mt-6">
           <button wire:click="submit"
                   @if(!$archive || $errors->any()) disabled @endif
                   class="w-full px-4 py-3 bg-primary-600 text-white rounded-lg font-medium
                          disabled:opacity-50 disabled:cursor-not-allowed
                          hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
               Upload and Process
           </button>
       </div>
       ```

       In Upload.php, add placeholder submit:
       ```php
       public function submit()
       {
           $this->validate();
           // Phase 3 will implement actual zip validation
           // For now, just show success notification
           \Filament\Notifications\Notification::make()
               ->title('File received')
               ->body('Archive uploaded successfully. Validation coming in Phase 3.')
               ->success()
               ->send();
       }
       ```

    Requirements covered:
    - UPLD-03: Progress bar during upload
    - UPLD-06: Cancel in-progress upload
    - UPLD-07: Remove/replace file before submission
  </action>
  <verify>
    1. Upload a large zip - progress bar shows percentage
    2. During upload, "Cancel upload" link appears and works
    3. After file selected, "Replace" and "Remove" buttons appear
    4. Click "Remove" - file is cleared
    5. Click "Replace" - file picker opens, new file replaces old
    6. Submit button disabled until valid file selected
  </verify>
  <done>
    - Progress bar shows upload percentage (UPLD-03)
    - Cancel button stops in-progress upload (UPLD-06)
    - Remove button clears selected file (UPLD-07)
    - Replace button allows changing file (UPLD-07)
    - Submit button ready for Phase 3 integration
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete file upload interface with drag-drop, validation, progress, and file controls</what-built>
  <how-to-verify>
    **Prerequisites:**
    - Database configured and migrated
    - Admin user seeded (admin/password)

    **Test flow:**
    1. Start server: `php artisan serve`
    2. Visit: http://localhost:8000/admin
    3. Login with: admin / password
    4. Click "Upload Archive" in navigation

    **Test UPLD-01 (Drag-drop):**
    - Drag a zip file over the upload zone
    - Border should change color (visual feedback)
    - Drop file - filename should appear

    **Test UPLD-02 (Click fallback):**
    - Click "Browse Files" button
    - File picker opens
    - Select a zip file - filename appears

    **Test UPLD-04 (Reject non-zip):**
    - Try to upload a .txt or .pdf file
    - Error message: "Only ZIP files are accepted"

    **Test UPLD-05 (Size limit shown):**
    - Upload zone shows "up to 100MB" text
    - (Size rejection only testable with >100MB file)

    **Test UPLD-03 (Progress bar):**
    - Upload a larger zip file (5MB+)
    - Progress bar appears with percentage

    **Test UPLD-06 (Cancel):**
    - Start uploading a file
    - Click "Cancel upload" during progress
    - Upload stops, file cleared

    **Test UPLD-07 (Remove/Replace):**
    - After file selected, "Replace" and "Remove" buttons visible
    - Click "Remove" - file cleared
    - Upload new file, click "Replace" - file picker opens
    - Select different file - replaces previous

    **Submit test:**
    - With valid zip selected, click "Upload and Process"
    - Success notification appears
  </how-to-verify>
  <resume-signal>Type "approved" if all 7 UPLD requirements work, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Zip-only validation works with clear error
- [ ] File size limit displayed (100MB)
- [ ] Progress bar shows during upload
- [ ] Cancel upload works during progress
- [ ] Remove file button clears selection
- [ ] Replace file button allows changing selection
- [ ] Submit button enabled only with valid file
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- UPLD-01: Drag-and-drop works (from Plan 01)
- UPLD-02: Click-to-upload works (from Plan 01)
- UPLD-03: Progress bar shows during upload
- UPLD-04: Non-zip files rejected with message
- UPLD-05: Size limit shown, oversized rejected
- UPLD-06: Cancel upload works
- UPLD-07: Remove and replace file works
- User verified complete upload flow
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-upload-core/02-02-SUMMARY.md`
</output>
