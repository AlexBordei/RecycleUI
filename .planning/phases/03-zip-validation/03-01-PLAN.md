---
phase: 03-zip-validation
plan: 01
type: execute
wave: 1
depends_on: ["02-02"]
files_modified: [app/Services/ZipValidatorService.php, tests/Feature/ZipValidatorTest.php]
autonomous: true
---

<objective>
Create the ZipValidatorService that extracts and validates zip archives against the 9-file schema.

Purpose: Core validation engine that ensures every folder in a zip contains the required document set.
Output: ZipValidatorService class with extraction, validation, and detailed error reporting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-upload-core/02-02-SUMMARY.md
@app/Filament/Pages/Upload.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ZipValidatorService with security measures</name>
  <files>app/Services/ZipValidatorService.php</files>
  <action>
    Create the validation service with proper security:

    1. Create `app/Services/ZipValidatorService.php`:
       ```php
       namespace App\Services;

       use ZipArchive;
       use Illuminate\Support\Facades\File;
       use Illuminate\Http\UploadedFile;

       class ZipValidatorService
       {
           /**
            * Required files for each folder (case-sensitive).
            */
           protected array $requiredFiles = [
               'ANEXA.pdf',
               'AVIZ.pdf',
               'Fata.jpeg',
               'Inc1.jpeg',
               'Inc2.jpeg',
               'Km.jpeg',
               'Lateral.jpeg',
               'Spate.jpeg',
           ];

           /**
            * Excel filename pattern (regex).
            * Matches: Iesiri_export_robotel_siatd_intern_DD_MM_YYYY_HH_MM_SS.xlsx
            */
           protected string $excelPattern = '/^Iesiri_export_robotel_siatd_intern_\d{2}_\d{2}_\d{4}_\d{2}_\d{2}_\d{2}\.xlsx$/i';

           /**
            * Temporary extraction path.
            */
           protected ?string $tempPath = null;

           /**
            * Validation errors collected during validation.
            */
           protected array $errors = [];

           /**
            * Folder structure from the zip (for preview).
            */
           protected array $structure = [];
       }
       ```

    2. Add extraction with Zip Slip prevention:
       ```php
       /**
        * Extract zip to temporary directory with security checks.
        *
        * @throws \RuntimeException If extraction fails or Zip Slip detected
        */
       public function extract(UploadedFile $file): string
       {
           $zip = new ZipArchive();
           $result = $zip->open($file->getRealPath());

           if ($result !== true) {
               throw new \RuntimeException('Failed to open zip file: ' . $this->getZipError($result));
           }

           // Create temp directory
           $this->tempPath = storage_path('app/temp/' . uniqid('zip_', true));
           File::makeDirectory($this->tempPath, 0755, true);

           // Extract with Zip Slip prevention
           for ($i = 0; $i < $zip->numFiles; $i++) {
               $filename = $zip->getNameIndex($i);
               $targetPath = $this->tempPath . '/' . $filename;

               // Zip Slip prevention: ensure path is within temp directory
               $realBase = realpath($this->tempPath);
               $realTarget = realpath(dirname($targetPath));

               // For new directories, check parent
               if ($realTarget === false) {
                   $realTarget = realpath(dirname(dirname($targetPath)));
               }

               if ($realTarget === false || strpos($realTarget, $realBase) !== 0) {
                   $this->cleanup();
                   throw new \RuntimeException('Zip Slip attack detected: ' . $filename);
               }

               $zip->extractTo($this->tempPath, $filename);
           }

           $zip->close();

           return $this->tempPath;
       }

       /**
        * Clean up temporary extraction directory.
        */
       public function cleanup(): void
       {
           if ($this->tempPath && File::isDirectory($this->tempPath)) {
               File::deleteDirectory($this->tempPath);
               $this->tempPath = null;
           }
       }

       protected function getZipError(int $code): string
       {
           $errors = [
               ZipArchive::ER_EXISTS => 'File already exists',
               ZipArchive::ER_INCONS => 'Zip archive inconsistent',
               ZipArchive::ER_INVAL => 'Invalid argument',
               ZipArchive::ER_MEMORY => 'Memory allocation failure',
               ZipArchive::ER_NOENT => 'No such file',
               ZipArchive::ER_NOZIP => 'Not a zip archive',
               ZipArchive::ER_OPEN => 'Cannot open file',
               ZipArchive::ER_READ => 'Read error',
               ZipArchive::ER_SEEK => 'Seek error',
           ];

           return $errors[$code] ?? 'Unknown error';
       }
       ```

    3. Add destructor for automatic cleanup:
       ```php
       public function __destruct()
       {
           $this->cleanup();
       }
       ```

    Security measures:
    - Zip Slip prevention validates all paths stay within temp directory
    - Temporary files cleaned up after use
    - Proper error handling for corrupt zips
  </action>
  <verify>
    1. Service class exists at app/Services/ZipValidatorService.php
    2. Has $requiredFiles array with 8 files
    3. Has $excelPattern regex for Excel validation
    4. extract() method creates temp directory
    5. Zip Slip prevention throws on path traversal
  </verify>
  <done>
    - ZipValidatorService created with security measures
    - Zip extraction with Zip Slip prevention
    - Automatic cleanup on destruction
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 9-file schema validation with detailed errors</name>
  <files>app/Services/ZipValidatorService.php</files>
  <action>
    Add validation logic to check each folder:

    1. Add the validate() method:
       ```php
       /**
        * Validate the extracted zip contents.
        *
        * @return array{valid: bool, errors: array, structure: array}
        */
       public function validate(): array
       {
           if (!$this->tempPath || !File::isDirectory($this->tempPath)) {
               throw new \RuntimeException('No extracted content to validate. Call extract() first.');
           }

           $this->errors = [];
           $this->structure = [];

           // Get all top-level directories (transport record folders)
           $folders = File::directories($this->tempPath);

           if (empty($folders)) {
               $this->errors['_root'] = ['Zip archive contains no folders. Expected folders with transport records.'];
               return $this->getResult();
           }

           foreach ($folders as $folder) {
               $this->validateFolder($folder);
           }

           return $this->getResult();
       }

       /**
        * Validate a single folder against the required schema.
        */
       protected function validateFolder(string $folderPath): void
       {
           $folderName = basename($folderPath);
           $files = File::files($folderPath);
           $fileNames = array_map(fn($f) => $f->getFilename(), $files);

           $this->structure[$folderName] = [
               'files' => $fileNames,
               'valid' => true,
               'missing' => [],
               'excel' => null,
           ];

           $folderErrors = [];

           // Check each required file
           foreach ($this->requiredFiles as $requiredFile) {
               if (!in_array($requiredFile, $fileNames, true)) {
                   $folderErrors[] = "Missing required file: {$requiredFile}";
                   $this->structure[$folderName]['missing'][] = $requiredFile;
               }
           }

           // Check for Excel file matching pattern
           $excelFound = false;
           foreach ($fileNames as $fileName) {
               if (preg_match($this->excelPattern, $fileName)) {
                   $excelFound = true;
                   $this->structure[$folderName]['excel'] = $fileName;
                   break;
               }
           }

           if (!$excelFound) {
               $folderErrors[] = 'Missing Excel file matching pattern: Iesiri_export_robotel_siatd_intern_DD_MM_YYYY_HH_MM_SS.xlsx';
               $this->structure[$folderName]['missing'][] = 'Excel (Iesiri_export_robotel_siatd_intern_*.xlsx)';
           }

           if (!empty($folderErrors)) {
               $this->errors[$folderName] = $folderErrors;
               $this->structure[$folderName]['valid'] = false;
           }
       }

       /**
        * Get the validation result.
        */
       protected function getResult(): array
       {
           return [
               'valid' => empty($this->errors),
               'errors' => $this->errors,
               'structure' => $this->structure,
           ];
       }

       /**
        * Get just the structure for preview (without full validation).
        */
       public function getStructure(): array
       {
           if (!$this->tempPath || !File::isDirectory($this->tempPath)) {
               throw new \RuntimeException('No extracted content. Call extract() first.');
           }

           $structure = [];
           $folders = File::directories($this->tempPath);

           foreach ($folders as $folder) {
               $folderName = basename($folder);
               $files = File::files($folder);
               $structure[$folderName] = array_map(fn($f) => $f->getFilename(), $files);
           }

           return $structure;
       }

       /**
        * Convenience method to extract and validate in one call.
        */
       public function extractAndValidate(UploadedFile $file): array
       {
           $this->extract($file);
           return $this->validate();
       }
       ```

    Requirements covered:
    - VALD-01: Validates 9 required files per folder (8 fixed + 1 Excel pattern)
    - VALD-02: Excel filename pattern validation with regex
    - VALD-03: Detailed errors per folder showing exactly what's missing
    - VALD-04: Returns valid=false if any folder has errors (entire zip rejected)
  </action>
  <verify>
    1. validate() returns {valid, errors, structure}
    2. Each folder checked for 8 required files + Excel pattern
    3. Errors keyed by folder name with array of missing files
    4. getStructure() returns file listing per folder
  </verify>
  <done>
    - 9-file schema validation implemented
    - Excel pattern matching with regex
    - Detailed error collection per folder
    - Structure preview for UI
  </done>
</task>

<task type="auto">
  <name>Task 3: Write tests for ZipValidatorService</name>
  <files>tests/Feature/ZipValidatorTest.php</files>
  <action>
    Create comprehensive tests for the validation service:

    1. Create `tests/Feature/ZipValidatorTest.php`:
       ```php
       <?php

       namespace Tests\Feature;

       use App\Services\ZipValidatorService;
       use Illuminate\Http\UploadedFile;
       use Illuminate\Support\Facades\File;
       use Tests\TestCase;
       use ZipArchive;

       class ZipValidatorTest extends TestCase
       {
           protected ZipValidatorService $validator;
           protected string $testZipPath;

           protected function setUp(): void
           {
               parent::setUp();
               $this->validator = new ZipValidatorService();
               $this->testZipPath = storage_path('app/test-zips');
               File::makeDirectory($this->testZipPath, 0755, true, true);
           }

           protected function tearDown(): void
           {
               File::deleteDirectory($this->testZipPath);
               parent::tearDown();
           }

           /**
            * Create a test zip file with specified structure.
            */
           protected function createTestZip(array $folders): UploadedFile
           {
               $zipPath = $this->testZipPath . '/' . uniqid('test_') . '.zip';
               $zip = new ZipArchive();
               $zip->open($zipPath, ZipArchive::CREATE);

               foreach ($folders as $folderName => $files) {
                   foreach ($files as $fileName) {
                       $zip->addFromString("{$folderName}/{$fileName}", 'test content');
                   }
               }

               $zip->close();

               return new UploadedFile(
                   $zipPath,
                   'test.zip',
                   'application/zip',
                   null,
                   true
               );
           }

           /** @test */
           public function it_validates_complete_folder_successfully()
           {
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf',
                       'AVIZ.pdf',
                       'Fata.jpeg',
                       'Inc1.jpeg',
                       'Inc2.jpeg',
                       'Km.jpeg',
                       'Lateral.jpeg',
                       'Spate.jpeg',
                       'Iesiri_export_robotel_siatd_intern_21_01_2026_10_30_00.xlsx',
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);

               $this->assertTrue($result['valid']);
               $this->assertEmpty($result['errors']);
               $this->assertArrayHasKey('Transport001', $result['structure']);
           }

           /** @test */
           public function it_detects_missing_required_files()
           {
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf',
                       'AVIZ.pdf',
                       // Missing: Fata.jpeg, Inc1.jpeg, Inc2.jpeg, Km.jpeg, Lateral.jpeg, Spate.jpeg
                       'Iesiri_export_robotel_siatd_intern_21_01_2026_10_30_00.xlsx',
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);

               $this->assertFalse($result['valid']);
               $this->assertArrayHasKey('Transport001', $result['errors']);
               $this->assertCount(6, $result['errors']['Transport001']); // 6 missing files
           }

           /** @test */
           public function it_detects_missing_excel_file()
           {
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf',
                       'AVIZ.pdf',
                       'Fata.jpeg',
                       'Inc1.jpeg',
                       'Inc2.jpeg',
                       'Km.jpeg',
                       'Lateral.jpeg',
                       'Spate.jpeg',
                       // Missing Excel file
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);

               $this->assertFalse($result['valid']);
               $this->assertStringContainsString('Excel', $result['errors']['Transport001'][0]);
           }

           /** @test */
           public function it_validates_excel_filename_pattern()
           {
               // Valid pattern
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf', 'AVIZ.pdf', 'Fata.jpeg', 'Inc1.jpeg',
                       'Inc2.jpeg', 'Km.jpeg', 'Lateral.jpeg', 'Spate.jpeg',
                       'Iesiri_export_robotel_siatd_intern_21_01_2026_10_30_00.xlsx',
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);
               $this->assertTrue($result['valid']);

               // Invalid pattern - wrong format
               $this->validator = new ZipValidatorService();
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf', 'AVIZ.pdf', 'Fata.jpeg', 'Inc1.jpeg',
                       'Inc2.jpeg', 'Km.jpeg', 'Lateral.jpeg', 'Spate.jpeg',
                       'random_excel_file.xlsx', // Wrong pattern
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);
               $this->assertFalse($result['valid']);
           }

           /** @test */
           public function it_validates_multiple_folders()
           {
               $file = $this->createTestZip([
                   'Transport001' => [
                       'ANEXA.pdf', 'AVIZ.pdf', 'Fata.jpeg', 'Inc1.jpeg',
                       'Inc2.jpeg', 'Km.jpeg', 'Lateral.jpeg', 'Spate.jpeg',
                       'Iesiri_export_robotel_siatd_intern_21_01_2026_10_30_00.xlsx',
                   ],
                   'Transport002' => [
                       'ANEXA.pdf', // Missing other files
                   ],
               ]);

               $result = $this->validator->extractAndValidate($file);

               $this->assertFalse($result['valid']);
               $this->assertArrayNotHasKey('Transport001', $result['errors']); // Valid folder
               $this->assertArrayHasKey('Transport002', $result['errors']); // Invalid folder
           }

           /** @test */
           public function it_rejects_empty_zip()
           {
               $file = $this->createTestZip([]);

               $result = $this->validator->extractAndValidate($file);

               $this->assertFalse($result['valid']);
               $this->assertArrayHasKey('_root', $result['errors']);
           }

           /** @test */
           public function it_provides_structure_for_preview()
           {
               $file = $this->createTestZip([
                   'Folder1' => ['file1.txt', 'file2.pdf'],
                   'Folder2' => ['file3.xlsx'],
               ]);

               $this->validator->extract($file);
               $structure = $this->validator->getStructure();

               $this->assertArrayHasKey('Folder1', $structure);
               $this->assertArrayHasKey('Folder2', $structure);
               $this->assertCount(2, $structure['Folder1']);
               $this->assertCount(1, $structure['Folder2']);
           }

           /** @test */
           public function it_cleans_up_temp_files()
           {
               $file = $this->createTestZip([
                   'Folder1' => ['file1.txt'],
               ]);

               $tempPath = $this->validator->extract($file);
               $this->assertTrue(File::isDirectory($tempPath));

               $this->validator->cleanup();
               $this->assertFalse(File::isDirectory($tempPath));
           }
       }
       ```

    2. Run tests to verify:
       `php artisan test --filter=ZipValidatorTest`
  </action>
  <verify>
    1. All tests pass: `php artisan test --filter=ZipValidatorTest`
    2. Tests cover: complete validation, missing files, Excel pattern, multiple folders, empty zip, preview structure, cleanup
  </verify>
  <done>
    - Comprehensive test suite for ZipValidatorService
    - All validation scenarios covered
    - Tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ZipValidatorService exists at app/Services/ZipValidatorService.php
- [ ] Zip Slip prevention implemented and tested
- [ ] 8 required files + Excel pattern validation works
- [ ] Detailed errors collected per folder
- [ ] getStructure() provides preview data
- [ ] All tests pass: `php artisan test --filter=ZipValidatorTest`
- [ ] Cleanup removes temp files
</verification>

<success_criteria>
- VALD-01: 9-file schema validation per folder
- VALD-02: Excel filename pattern validation
- VALD-03: Detailed errors per folder/file
- VALD-04: valid=false if any folder fails
- Security: Zip Slip prevention implemented
- Tests: Comprehensive test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/03-zip-validation/03-01-SUMMARY.md`
</output>
