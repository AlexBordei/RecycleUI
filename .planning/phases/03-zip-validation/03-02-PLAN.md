---
phase: 03-zip-validation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php]
autonomous: false
---

<objective>
Integrate ZipValidatorService into the Upload page with preview and detailed error display.

Purpose: Connect validation engine to UI so users see zip contents and validation results.
Output: Complete upload flow with preview, validation, and detailed error messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zip-validation/03-01-SUMMARY.md
@app/Filament/Pages/Upload.php
@resources/views/filament/pages/upload.blade.php
@app/Services/ZipValidatorService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add zip contents preview to Upload page</name>
  <files>app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php</files>
  <action>
    Add preview functionality that shows zip contents before validation:

    1. In Upload.php, add preview properties and method:
       ```php
       use App\Services\ZipValidatorService;

       /**
        * Preview of zip structure (folder -> files).
        */
       public array $preview = [];

       /**
        * Whether preview is currently loading.
        */
       public bool $previewLoading = false;

       /**
        * Generate preview of zip contents.
        */
       public function generatePreview(): void
       {
           if (!$this->archive) {
               return;
           }

           $this->previewLoading = true;

           try {
               $validator = new ZipValidatorService();
               $validator->extract($this->archive);
               $this->preview = $validator->getStructure();
           } catch (\Exception $e) {
               $this->addError('archive', 'Failed to read zip contents: ' . $e->getMessage());
               $this->preview = [];
           }

           $this->previewLoading = false;
       }
       ```

    2. Update updatedArchive() to trigger preview:
       ```php
       public function updatedArchive(): void
       {
           $this->validateOnly('archive');

           // Generate preview if file is valid
           if (!$this->getErrorBag()->has('archive') && $this->archive) {
               $this->generatePreview();
           } else {
               $this->preview = [];
           }
       }
       ```

    3. Update removeFile() to clear preview:
       ```php
       public function removeFile(): void
       {
           $this->archive = null;
           $this->preview = [];
           $this->resetValidation('archive');
       }
       ```

    4. In upload.blade.php, add preview section after file selection:
       ```blade
       {{-- Zip contents preview --}}
       @if(!empty($preview))
           <div class="mt-4 p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg">
               <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">
                   <x-heroicon-o-folder-open class="w-4 h-4 inline-block mr-1" />
                   Zip Contents Preview
               </h3>
               <div class="space-y-3 max-h-64 overflow-y-auto">
                   @foreach($preview as $folder => $files)
                       <div class="pl-2 border-l-2 border-gray-200 dark:border-gray-700">
                           <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                               <x-heroicon-o-folder class="w-4 h-4 inline-block mr-1 text-yellow-500" />
                               {{ $folder }}
                               <span class="text-xs text-gray-500">({{ count($files) }} files)</span>
                           </p>
                           <ul class="mt-1 ml-5 text-xs text-gray-500 dark:text-gray-400 space-y-0.5">
                               @foreach($files as $file)
                                   <li class="flex items-center">
                                       <x-heroicon-o-document class="w-3 h-3 mr-1 flex-shrink-0" />
                                       {{ $file }}
                                   </li>
                               @endforeach
                           </ul>
                       </div>
                   @endforeach
               </div>
               <p class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                   {{ count($preview) }} folder(s) found
               </p>
           </div>
       @endif
       ```

    Requirement covered:
    - UPLD-08: User can preview zip contents (file listing) before submission
  </action>
  <verify>
    1. Upload a valid zip file
    2. Preview section appears showing folder structure
    3. Each folder shows its files
    4. Scrollable if many folders
    5. Preview clears when file is removed
  </verify>
  <done>
    - Zip contents preview shows after file selection
    - Folder/file structure clearly displayed
    - Preview updates on file change
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation into submit flow with detailed errors</name>
  <files>app/Filament/Pages/Upload.php, resources/views/filament/pages/upload.blade.php</files>
  <action>
    Connect the validation service to the submit flow:

    1. In Upload.php, add validation result properties:
       ```php
       /**
        * Validation result from ZipValidatorService.
        */
       public ?array $validationResult = null;

       /**
        * Whether validation is in progress.
        */
       public bool $validating = false;
       ```

    2. Update submit() to use ZipValidatorService:
       ```php
       public function submit(): void
       {
           $this->validate();
           $this->validating = true;
           $this->validationResult = null;

           try {
               $validator = new ZipValidatorService();
               $this->validationResult = $validator->extractAndValidate($this->archive);

               if ($this->validationResult['valid']) {
                   // Valid zip - Phase 4 will handle extraction
                   Notification::make()
                       ->title('Validation Passed')
                       ->body('All ' . count($this->validationResult['structure']) . ' folders contain the required files.')
                       ->success()
                       ->send();
               } else {
                   // Invalid zip - show errors
                   $errorCount = array_sum(array_map('count', $this->validationResult['errors']));
                   Notification::make()
                       ->title('Validation Failed')
                       ->body("Found {$errorCount} issue(s) in " . count($this->validationResult['errors']) . " folder(s). See details below.")
                       ->danger()
                       ->send();
               }
           } catch (\Exception $e) {
               Notification::make()
                   ->title('Validation Error')
                   ->body('Failed to validate zip: ' . $e->getMessage())
                   ->danger()
                   ->send();
           }

           $this->validating = false;
       }
       ```

    3. Update removeFile() to clear validation:
       ```php
       public function removeFile(): void
       {
           $this->archive = null;
           $this->preview = [];
           $this->validationResult = null;
           $this->resetValidation('archive');
       }
       ```

    4. In upload.blade.php, add validation results display:
       ```blade
       {{-- Validation results --}}
       @if($validationResult)
           @if($validationResult['valid'])
               <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                   <div class="flex items-center">
                       <x-heroicon-o-check-circle class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" />
                       <span class="text-sm font-medium text-green-700 dark:text-green-300">
                           Validation Passed - All folders contain required files
                       </span>
                   </div>
                   <div class="mt-3 ml-7">
                       <p class="text-xs text-green-600 dark:text-green-400">
                           {{ count($validationResult['structure']) }} folder(s) validated successfully.
                           Ready for extraction in Phase 4.
                       </p>
                   </div>
               </div>
           @else
               <div class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                   <div class="flex items-center">
                       <x-heroicon-o-x-circle class="w-5 h-5 text-red-500 mr-2 flex-shrink-0" />
                       <span class="text-sm font-medium text-red-700 dark:text-red-300">
                           Validation Failed - Missing required files
                       </span>
                   </div>
                   <div class="mt-3 space-y-3">
                       @foreach($validationResult['errors'] as $folder => $errors)
                           <div class="ml-7 p-3 bg-red-100 dark:bg-red-900/30 rounded">
                               <p class="text-sm font-medium text-red-800 dark:text-red-200">
                                   <x-heroicon-o-folder class="w-4 h-4 inline-block mr-1" />
                                   {{ $folder === '_root' ? 'Archive Structure' : $folder }}
                               </p>
                               <ul class="mt-2 space-y-1">
                                   @foreach($errors as $error)
                                       <li class="text-xs text-red-700 dark:text-red-300 flex items-start">
                                           <x-heroicon-o-exclamation-triangle class="w-3 h-3 mr-1 mt-0.5 flex-shrink-0" />
                                           {{ $error }}
                                       </li>
                                   @endforeach
                               </ul>
                           </div>
                       @endforeach
                   </div>
                   <p class="mt-3 ml-7 text-xs text-red-600 dark:text-red-400">
                       Please fix the issues above and upload a corrected archive.
                   </p>
               </div>
           @endif
       @endif
       ```

    5. Update submit button to show validation state:
       ```blade
       <div class="mt-6">
           <button type="button"
                   wire:click="submit"
                   wire:loading.attr="disabled"
                   @if($validating) disabled @endif
                   class="w-full px-4 py-3 bg-primary-600 text-white rounded-lg font-medium
                          hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2
                          disabled:opacity-50 disabled:cursor-not-allowed
                          transition-colors duration-200">
               @if($validating)
                   <span class="flex items-center justify-center">
                       <x-filament::loading-indicator class="h-5 w-5 mr-2" />
                       Validating...
                   </span>
               @else
                   <span wire:loading.remove wire:target="submit">Validate and Process</span>
                   <span wire:loading wire:target="submit" class="flex items-center justify-center">
                       <x-filament::loading-indicator class="h-5 w-5 mr-2" />
                       Processing...
                   </span>
               @endif
           </button>
       </div>
       ```

    Requirements covered:
    - VALD-03: Detailed error messages identifying exactly which folder is missing which file
    - VALD-04: Entire zip rejected if any folder is invalid
  </action>
  <verify>
    1. Upload valid zip - validation passes with success message
    2. Upload invalid zip - detailed errors shown per folder
    3. Error display shows folder name and missing files
    4. Button shows "Validating..." during process
    5. Can remove file and try again after failure
  </verify>
  <done>
    - Validation integrated into submit flow
    - Success state shows for valid zips
    - Detailed errors per folder for invalid zips
    - Loading state during validation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete zip validation engine with preview and detailed error reporting</what-built>
  <how-to-verify>
    **Prerequisites:**
    - Database configured and migrated
    - Admin user seeded (admin/password)
    - Create test zip files for testing (instructions below)

    **Create test files:**

    1. **Valid zip** (transport_valid.zip):
       Create a folder "Transport001" with files:
       - ANEXA.pdf (any PDF)
       - AVIZ.pdf (any PDF)
       - Fata.jpeg (any JPEG)
       - Inc1.jpeg (any JPEG)
       - Inc2.jpeg (any JPEG)
       - Km.jpeg (any JPEG)
       - Lateral.jpeg (any JPEG)
       - Spate.jpeg (any JPEG)
       - Iesiri_export_robotel_siatd_intern_21_01_2026_10_30_00.xlsx (any Excel file renamed)

    2. **Invalid zip** (transport_invalid.zip):
       Create a folder "Transport002" with only:
       - ANEXA.pdf
       - AVIZ.pdf
       (Missing 7 files)

    **Test flow:**
    1. Start server: `php artisan serve`
    2. Visit: http://localhost:8000/admin
    3. Login with: admin / password
    4. Click "Upload Archive" in navigation

    **Test UPLD-08 (Preview):**
    - Upload a zip file
    - Preview section shows folder structure
    - Each folder lists its files

    **Test VALD-01 (9-file validation):**
    - Upload transport_valid.zip
    - Click "Validate and Process"
    - Success message appears

    **Test VALD-02 (Excel pattern):**
    - Create zip with wrong Excel name (e.g., "data.xlsx")
    - Validation fails with Excel pattern error

    **Test VALD-03 (Detailed errors):**
    - Upload transport_invalid.zip
    - Validation shows errors per folder
    - Each missing file listed

    **Test VALD-04 (Reject invalid):**
    - Even one invalid folder fails entire validation
    - No partial success

    **Test error recovery:**
    - After validation failure, click Remove
    - Upload corrected file
    - Validation passes
  </how-to-verify>
  <resume-signal>Type "approved" if all validation requirements work, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Preview shows zip contents after selection
- [ ] Validation integrates with submit button
- [ ] Valid zips show success message
- [ ] Invalid zips show detailed errors per folder
- [ ] Missing files clearly identified
- [ ] Excel pattern validation works
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- UPLD-08: Preview zip contents before submission
- VALD-01: 9-file validation per folder (via 03-01)
- VALD-02: Excel pattern validation (via 03-01)
- VALD-03: Detailed errors per folder/file
- VALD-04: Reject if any folder invalid
- User verified complete validation flow
</success_criteria>

<output>
After completion, create `.planning/phases/03-zip-validation/03-02-SUMMARY.md`
</output>
